package io.petermueller.petrinetz.models.rgraph;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import io.petermueller.petrinetz.models.petrinet.Place;
import io.petermueller.petrinetz.models.petrinet.Transition;

public class RGraphModel  {
	public List<Marking> markings;
	public List<TransitionArc> arcs;
	
	public RGraphModel() {
		markings = new ArrayList<Marking>();
		arcs = new ArrayList<TransitionArc>();
	}
	
	public void addTransition(
			List<Place> places,
			Transition lastTransition) {
		Marking source = getActiveMarking();
		addMarking(places);
		addArc(lastTransition, source);
	}
	
	public void addMarking(List<Place> places) {
		String id = getMarkingId(places);
		if (!markingExists(id)) {
			Marking marking = new Marking(id, true);
			markings.add(marking);
			setAsActiveMarking(marking);
		} else {
			setAsActiveMarking(getMarkingById(id));
		}
	}
	
	public void reset(List<Place> places) {
		markings = new ArrayList<Marking>();
		arcs = new ArrayList<TransitionArc>();
		addMarking(places);
	}
	
	protected void addArc(Transition lastTransition, Marking source) {
		String id = getTransitionId(lastTransition);
		Marking target = getActiveMarking();
		if (!transitionExists(id, source, target)) {
			TransitionArc arc = new TransitionArc(id, source, target);
			arcs.add(arc);
		}
	}
	
	private String getMarkingId(List<Place> places) {
		sortPlaces(places);
		String id = "(";
		for (Place place : places) {
			id = id + place.currentTokens + "|";
		}
		id = id.substring(0, id.length() - 1);
		id = id + ")";
		return id;
	};
	
	private Marking getMarkingById(String id) {
		for (Marking marking : markings) {
			if (marking.id.equals(id)) {
				return marking;
			}
		}
		return null;
	}
	
	private void sortPlaces(List<Place> places) {
		Collections.sort(places, new Comparator<Place>() {
			@Override
			public int compare(Place o1, Place o2) {
				return o1.id.compareTo(o2.id);
			}
		});
	}
	
	private String getTransitionId(Transition lastTransition) {
		return "[" + lastTransition.id + "] " + lastTransition.name;
	}
	
	private Boolean markingExists(String id) {
		if (getMarkingById(id) != null) {
			return true;
		}
		return false;
	}
	
	private Boolean transitionExists(
			String id,
			Marking source,
			Marking target) {
		for (TransitionArc arc : arcs) {
			if (arc.id.equals(id) &&
				arc.source == source &&
				arc.target == target) {
				return true;
			}
		}
		return false;
	}
	
	private void setAsActiveMarking(Marking activeMarking) {
		for (Marking marking : markings) {
			if (marking.id.equals(activeMarking.id)) {
				marking.isActive = true;
			} else {
				marking.isActive = false;
			}
		}
	}
	
	private Marking getActiveMarking() {
		for (Marking marking : markings) {
			if (marking.isActive) {
				return marking;
			}
		}
		return null;
	}
}