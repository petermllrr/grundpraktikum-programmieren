package io.petermueller.petrinetz.views;

import java.awt.BorderLayout;
import java.awt.Color;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.ListIterator;

import javax.swing.*;
import org.graphstream.graph.*;
import org.graphstream.graph.implementations.*;
import org.graphstream.ui.swing_viewer.SwingViewer;
import org.graphstream.ui.swing_viewer.ViewPanel;
import org.graphstream.ui.spriteManager.*;
import io.petermueller.petrinetz.models.petrinet.*;

public class PetriNetView {
	public JPanel panel;
	private Graph graph;
	public ViewPanel view;
	public SwingViewer viewer;
	private SpriteManager sman;
	
	public PetriNetView() {
		panel = new JPanel();
		graph = new MultiGraph("Graph");
		viewer = new SwingViewer(
			graph,
			SwingViewer.ThreadingModel.GRAPH_IN_GUI_THREAD
		);
		view = (ViewPanel) viewer.addDefaultView(false);
		sman = new SpriteManager(graph);
		
		panel.setBackground(Color.white);	
		panel.setBorder(
			BorderFactory.createLineBorder(new Color(0xDADCE0), 1)
		);
		panel.setLayout(new BorderLayout());
		panel.add((JPanel) view, BorderLayout.CENTER);
	}
	
	private void initGraph() {
		graph.setAttribute("ui.quality");
		graph.setAttribute("ui.antialias");
		graph.setAttribute("ui.stylesheet", initStyleSheet());
	}
	
	public void renderPetriNet(
		List<Transition> transitions,
		List<Place> places,
		List<Arc> arcs) {
		graph.clear();
		clearSprites();
		initGraph();
		for (Transition element : transitions) {
			graph.addNode(element.id);
			graph.getNode(element.id).setAttribute("x", element.x);
			graph.getNode(element.id).setAttribute("y", element.y);
			graph.getNode(element.id).setAttribute(
				"ui.label",
				"[" + element.id + "] " + element.name
			);
			if (element.isEnabled) {
				graph.getNode(element.id).setAttribute(
					"ui.class", 
					"transitionEnabled"
				);
				Sprite sprite = sman.addSprite(element.id + "_enabled");
				sprite.attachToNode(element.id);
				sprite.setAttribute("ui.class", "enabledTransition");
			} else {
				graph.getNode(element.id).setAttribute(
					"ui.class",
					"transition"
				);
			}
		}
		for (Place element : places) {
			graph.addNode(element.id);
			graph.getNode(element.id).setAttribute("x", element.x);
			graph.getNode(element.id).setAttribute("y", element.y);
			graph.getNode(element.id).setAttribute("ui.class", "place");
			if (element.tokens > 0) {
				Sprite sprite = sman.addSprite(element.id + "_tokens");
				sprite.attachToNode(element.id);
				sprite.setAttribute("ui.label", element.tokens);
				if (element.tokens > 9) {
					sprite.setAttribute("ui.class", "full");
				}
			}
			if (element.tokens > 0) {
				graph.getNode(element.id).setAttribute(
					"ui.label",
					"[" + element.id + "] " + element.name + " <"
					+ element.tokens +">"
				);
			} else {
				graph.getNode(element.id).setAttribute(
					"ui.label",
					"[" + element.id + "] " + element.name
				);
			}
		}
		for (Arc element : arcs) {
			graph.addEdge(element.id,
				element.source.id,
				element.target.id,
				true);
			graph.getEdge(element.id).setAttribute("ui.class", "arc");
			graph.getEdge(element.id).setAttribute(
				"ui.label",
				"[" + element.id + "]"
			);
		}
		view.getCamera().resetView();
	}
	
	public void updatePetriNet(
		List<Transition> transitions,
		List<Place> places) {
		for (Transition element : transitions) {
			if (element.isEnabled) {
				graph.getNode(element.id).setAttribute(
					"ui.class", 
					"transitionEnabled"
				);
				if (!hasSprite(element)) {
					Sprite sprite = sman.addSprite(element.id + "_enabled");
					sprite.attachToNode(element.id);
					sprite.setAttribute("ui.class", "enabledTransition");
				}
			} else {
				graph.getNode(element.id).setAttribute(
					"ui.class",
					"transition"
				);
				removeSprite(element.id + "_enabled");
			}
		}
		for (Place element : places) {
			if (element.tokens > 0) {
				graph.getNode(element.id).setAttribute(
						"ui.label",
						"[" + element.id + "] " + element.name + " <"
						+ element.tokens +">"
					);
				if(hasSprite(element)) {
					Sprite sprite = getSprite(element);
					sprite.setAttribute("ui.label", element.tokens);
				}
				if(!hasSprite(element)) {
					Sprite sprite = sman.addSprite(element.id + "_tokens");
					sprite.attachToNode(element.id);
					sprite.setAttribute("ui.label", element.tokens);
					if (element.tokens > 9) {
						sprite.setAttribute("ui.class", "full");
					}
				}
			} else {
				graph.getNode(element.id).setAttribute(
					"ui.label",
					"[" + element.id + "] " + element.name
				);
				removeSprite(element.id + "_tokens");
			}
		}
	}
	
	private Boolean hasSprite(Location element) {
		Boolean result = false;
		List<Sprite> spriteList = getSprites();
		for (Sprite sprite : spriteList) {
			if (sprite.getId().equals(element.id + "_tokens") || 
					sprite.getId().equals(element.id + "_enabled")) {
				result = true;
			}
		}
		return result;
	}
	
	private Sprite getSprite(Location element) {
		Sprite result = null;
		List<Sprite> spriteList = getSprites();
		for (Sprite sprite : spriteList) {
			if (sprite.getId().equals(element.id + "_tokens") || 
					sprite.getId().equals(element.id + "_enabled")) {
				result = sprite;
			}
		}
		return result;
	}
	
	private void clearSprites() {
		List<Sprite> spriteList = getSprites();
		for (Sprite sprite : spriteList) {
			sman.removeSprite(sprite.getId());
		}
	}
	
	private List<Sprite> getSprites() {
		Iterator<? extends Sprite> spriteIter = sman.sprites().iterator();
		List<Sprite> spriteList = new ArrayList<Sprite>();
		while (spriteIter.hasNext()) {
			spriteList.add(spriteIter.next());
		}
		return spriteList;
	}
	
	private void removeSprite(String spriteId) {
		List<Sprite> spriteList = getSprites();
		for (Sprite sprite : spriteList) {
			if (sprite.getId().equals(spriteId)) {
				sman.removeSprite(spriteId);
			}
		}
	}
	
	private String initStyleSheet() {
		String styleSheet;
		styleSheet =
	        "node {" +
	        "  fill-color: #FCC934;" + // Yellow400
	        "  stroke-color: #F9AB00;" + // Yellow600
	        "  text-background-color: #FEEFC3;" +
	        "  text-color: #AE5901;" +
	        "  stroke-width: 1px;" +
	        "  stroke-mode: plain; " +
	        "  size: 32px;" +
	        "  text-size: 11;" +
	        "  text-background-mode: rounded-box;" +
	        "  text-alignment: under;" +
	        "  text-offset: 0px, 9px;" +
	        "  text-padding: 3px, 0px;" +
	        "}" +
	        "node.transition {" +
	        "  fill-color: #AECBFA;" + // Blue200
	        "  stroke-color: #669DF6;" + //Blue400
	        "  text-background-color: #D2E3FC;" +
	        "  text-color: #185ABC;" +
	        "  shape: box;" +
	        "}" +
	        "node.transitionEnabled {" +
	        "  fill-color: #669DF6;" + // Blue400
	        "  stroke-color: #1A73E8;" + //Blue600
	        "  text-background-color: #669DF6;" + //D2E3FC
	        "  stroke-width: 1px;" +
	        "  text-color: #FFFFFF;" +
	        "  shadow-mode: plain;" +
	        "  shadow-color: #669DF63F;" +
	        "  shadow-width: 3px;" +
	        "  shadow-offset: 0px;" +
	        "  shape: box;" +
	        "}" +
	        "edge {" +
	        "  fill-color: #3C4043;" +
	        "  text-background-color: #F1F3F4;" +
	        "  text-color: #3C4043;" +
	        "  text-size: 11;" +
	        "  arrow-shape: arrow;" +
	        "  arrow-size: 4px, 3px;" +
	        "  text-background-mode: rounded-box;" +
	        "  text-padding: 3px, 0px;" +
	        "}" +
			"sprite {" +
	        "  fill-mode: plain;" +
	        "  shape: circle;" +
	        "  fill-color: #AE5901;" +
	        "  text-color: #FFFFFF;" +
	        "  text-size: 10;" +
	        "  size: 18px;" +
	        "  text-offset: 0px, -2px;" +
	        "  text-style: bold;" +
	        "}" +
			"sprite.full {" +
	        "  fill-mode: none;" +
	        "  text-background-mode: rounded-box;" +
	        "  text-background-color: #AE5901;"  +
	        "  text-color: #FFFFFF;" +
	        "  text-size: 10;" +
	        "  text-offset: 0px, -2px;" +
	        "  text-style: bold;" +
	        "}" +
	        "sprite.enabledTransition {" +
	        "  fill-mode: image-scaled;" +
	        "  fill-image: url('ic_enabled_transition_20x20@2x.png');" +
	        "  size: 20px;" +
	        "}";
		
		 return styleSheet;
	}
}
