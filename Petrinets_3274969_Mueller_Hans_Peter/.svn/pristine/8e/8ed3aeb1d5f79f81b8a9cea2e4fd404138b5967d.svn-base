package io.petermueller.petrinetz.models.petrinet;

import java.util.ArrayList;
import java.util.List;

import io.petermueller.petrinetz.controllers.Event;
import io.petermueller.petrinetz.controllers.EventListener;

public class PetriNetModel {
	public List<Transition> transitions;
	public List<Place> places;
	public List<Arc> arcs;
	private List<EventListener> listeners = new ArrayList<EventListener>();
	
	public PetriNetModel() {
		transitions = new ArrayList<Transition>();
		places = new ArrayList<Place>();
		arcs = new ArrayList<Arc>();
	}
	
	public void addEventListener(EventListener listener) {
		listeners.add(listener);
	}
	
	private void fireEvent(Event eventType) {
		for (EventListener listener : listeners) {
			listener.event(eventType);
		}
	}
	
	public void clear() {
		transitions.clear();
		places.clear();
		arcs.clear();
	}
	
	public void addTransition(String id) {
		transitions.add(new Transition(id));
		updateTransitions();
	}
	
	public void addPlace(String id) {
		places.add(new Place(id));
		updateTransitions();
	}
	
	public void addArc(String id, String source, String target) {
		Location sourceObj = findLocation(source);
		Location targetObj = findLocation(target);
		arcs.add(new Arc(id, sourceObj, targetObj));
		updateTransitions();
	}
	
	public void setName(String id, String name) {
		Location location = findLocation(id);
		location.name = name;
	}
	
	public void setTokens(String id, int tokens) {
		Location location = findLocation(id);
		Place place = (Place) location;
		place.tokens = tokens;
		updateTransitions();
	}
	
	public void setPosition(String id, int x, int y) {
		Location location = findLocation(id);
		location.x = x;
		location.y = y * (-1);
	}
	
	public Location findLocation(String id) {
		Location foundObject = null;
		try {
			for (Transition transition : transitions) {
				if (transition.id.equals(id)) {
					foundObject = transition;
				}
			}
			for (Place place : places) {
				if (place.id.equals(id)) {
					foundObject = place;
				}
			}
			if (foundObject == null) {
				throw new Exception("Location " + id + " not found.");
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return foundObject;
	}
	
	public String getContentsAsString() {
		String text = "Transitions: ";
		for (Transition transition : transitions) {
			text = text + "<" + transition.id + ", "
					          + transition.name + ", x: "
					          + transition.x + ", y: "
					          + transition.y + ">, ";
		}
		text = text + "\n";
		text = text + "Places: ";
		for (Place place : places) {
			text = text + "<" + place.id + ", "
						      + place.name + " "
						      + place.tokens + ", x: "
							  + place.x + ", y: "
							  + place.y + ">, ";
		}
		text = text + "\n";
		text = text + "Arcs: ";
		for (Arc arc : arcs) {
			text = text + "<" + arc.id + ", "
							  + arc.source.id + ", "
							  + arc.target.id + ">, ";
		}
		return text;
	}
	
	public void updateTransitions() {
		for (Transition transition : transitions) {
			if (hasTruePreconditions(transition)) {
				transition.isEnabled = true;
			} else {
				transition.isEnabled = false;
			}
		}
	}
	
	public List<Place> getInputs(Transition transition) {
		List<Place> inputs = new ArrayList<Place>();
		for (Arc arc : arcs) {
			if (arc.target == transition) {
				inputs.add((Place) arc.source);
			}
		}
		return inputs;
	}
	
	public List<Place> getOutputs(Transition transition) {
		List<Place> outputs = new ArrayList<Place>();
		for (Arc arc : arcs) {
			if (arc.source == transition) {
				outputs.add((Place) arc.target);
			}
		}
		return outputs;
	}
	
	public Boolean hasTruePreconditions(Transition transition) {
		List<Place> preconditions = getInputs(transition);
		Boolean result = true;
		for (Place place : preconditions) {
			if (place.tokens < 1) {
				result = false;
			}
		}
		return result;
	}
	
	public Location getLocation(String query) {
		Location element = null;
		for (Transition transition : transitions) {
			if (transition.id.equals(query)) {
				element = transition;
			}
		}
		for (Place place : places) {
			if (place.id.equals(query)) {
				element = place;
			}
		}
		return element;
	}
	
	public void fire(Transition transition) {
		if (hasTruePreconditions(transition)) {
			List<Place> inputs = getInputs(transition);
			List<Place> outputs = getOutputs(transition);
			for (Place place : inputs) {
				place.tokens --;
			}
			for (Place place : outputs) {
				place.tokens ++;
			}
			updateTransitions();
			fireEvent(Event.PETRINET_UPDATED);
		}
	}
}