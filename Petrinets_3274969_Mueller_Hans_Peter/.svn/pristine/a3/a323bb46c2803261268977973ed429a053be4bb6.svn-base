package io.petermueller.petrinetz.controllers;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.io.File;
import java.util.List;

import javax.swing.JFrame;
import javax.swing.KeyStroke;

import io.petermueller.petrinetz.models.filesystem.FileSystemModel;
import io.petermueller.petrinetz.models.petrinet.PetriNetModel;
import io.petermueller.petrinetz.util.BatchProcessing;
import io.petermueller.petrinetz.views.InfoDialogView;
import io.petermueller.petrinetz.views.MainFrameView;
import io.petermueller.petrinetz.views.TextAreaView;

public class MainFrameController {
	private MainFrameView mainFrameView;
	private FileSystemModel fileSystemModel;
	private PetriNetModel petriNetModel;
	private TextAreaView textAreaView;

	public MainFrameController(
			MainFrameView mainFrameView,
			FileSystemModel fileSystemModel,
			PetriNetModel petriNetModel,
			TextAreaView textAreaView) {
		this.mainFrameView = mainFrameView;
		this.fileSystemModel = fileSystemModel;
		this.petriNetModel = petriNetModel;
		this.textAreaView = textAreaView;
		addCloseOperation();
		addMenuListeners();
		addMenuShortcuts();
	}

	private void addCloseOperation() {
		mainFrameView.mainFrame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
	}

	private void addMenuListeners() {
		MenuListener menuListener = new MenuListener();
		mainFrameView.menuOpen.addActionListener(menuListener);
		mainFrameView.menuBatchProcessing.addActionListener(menuListener);
		mainFrameView.menuQuit.addActionListener(menuListener);
		mainFrameView.menuInfo.addActionListener(menuListener);
		mainFrameView.menuReload.addActionListener(menuListener);
	}

	private void addMenuShortcuts() {
		mainFrameView.menuOpen.setAccelerator(KeyStroke.getKeyStroke(
				KeyEvent.VK_O, ActionEvent.ALT_MASK));
		mainFrameView.menuBatchProcessing.setAccelerator(KeyStroke.getKeyStroke(
				KeyEvent.VK_O, ActionEvent.SHIFT_MASK));
		mainFrameView.menuQuit.setAccelerator(KeyStroke.getKeyStroke(
				KeyEvent.VK_Q, ActionEvent.ALT_MASK));
		mainFrameView.menuInfo.setAccelerator(KeyStroke.getKeyStroke(
				KeyEvent.VK_I, ActionEvent.ALT_MASK));
		mainFrameView.menuReload.setAccelerator(KeyStroke.getKeyStroke(
				KeyEvent.VK_R, ActionEvent.ALT_MASK));
	}

	private class MenuListener implements ActionListener {
		@Override
		public void actionPerformed(ActionEvent e) {
			if (e.getActionCommand().equals("Open…")) {
				PetriNetModel loadedPetriNet = fileSystemModel.readNewFile(
						mainFrameView.mainFrame);
				if (loadedPetriNet != null) {
					petriNetModel.load(loadedPetriNet);
					fileSystemModel.notifyGui();
				}
			}

			else if (e.getActionCommand().equals("Open Multiple Files…")) {
				List<PetriNetModel> petriNets = fileSystemModel.readNewFiles(
						mainFrameView.mainFrame);
				if (petriNets != null) {
					BatchProcessing batch = new BatchProcessing(petriNets);
					textAreaView.printBatchResults(batch);
				}
			}
			
			else if (e.getActionCommand().equals("Quit")) {
				System.exit(0);
			}
			
			else if (e.getActionCommand().equals("Info…")) {
				InfoDialogView infoDialogView = new InfoDialogView(
						mainFrameView.mainFrame);
				new InfoDialogController(infoDialogView);
			}
			
			else if (e.getActionCommand().equals("Reload")) {
				File currentFile = fileSystemModel.getCurrentFile();
				petriNetModel.load(fileSystemModel.readNewFile(currentFile));
				fileSystemModel.notifyGui();
			}
		}
	}
}